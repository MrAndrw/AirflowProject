# Перед началом работы с программой

1. Создать виртуальное окружение и установить requirements.txt 
2. Создать папку D:\analytics и переместить в нее файл take.txt из репозитория 
3. В файле parameters.ini указать необходимые папки и параметры для работы:
логин, пароль, id для папки For Sort для сайта OMP files
4. Для монго: ip адрес, имя пользователя и пароль рабочей базы, url локальной базы. 
5. Для телеграмма: api id, hash

### Рабочие папки:
    1. files_path - папка для загружаемых файлов
    2. images_path - папка для файлов с информацией о загружаемых файлах
    3. archives_with_duplicates - папка для повторяющихся архивов (дупликаты)
    4. directory - папка для новых архивов
    5. collection_files_path - папка для коллекций файлов
    6. session_telegram - папка для сохранения сессии телеграмма

Все рабочие папки должны быть разные. Рабочие папки могут находиться в общем каталоге.

При выполнении программы возможна работа в двух вариациях: через вебсервис airflow, или через
консоль.

# При работе с программой через веб-интерфейс Airflow на Windows
Необходимо установить Docker.
### Пошагово:
1. Запустить файл set_parameters.py для создания .env файла
2. Собрать докер-контейнеры, используя: docker-compose build --no-cache
3. Запустить докер-контейнеры, используя: docker-compose up -d  
4. Перейти на localhost:8080 для взаимодействия с DUGs 

# При работе с программой через веб-интерфейс Airflow на виртуальном сервере
### Пошагово:
1. Подключиться к серверу: ssh root@{id}
2. Активировать виртуальное окружение: source /opt/airflow/venv/bin/activate
3. Перейти в основную директорию программы: cd /opt/airflow
4. Добавить путь к Python: export PYTHONPATH=/opt/airflow
2. Запустить докер-контейнеры, используя: docker-compose up -d  
3. Перейти на http://{id}:8080/ для взаимодействия с DUGs 

### Даг 1 - ETL_Процесс_Загрузки_Файлов
Даг ETL_Процесс_Загрузки_Файлов запускает программу, при его выполнении программа 
загружает все непрочитанные файлы из всех каналов Telegram.

### Даг 2 - ETL_Процесс_Загрузки_Метаинформации
При успешном выполнении первого дага, запускается второй даг:
ETL_Процесс_Загрузки_Метаинформации. При его выполнении программа будет сравнивать загруженные файлы с теми, которые есть в 
телеграмм каналах и собирать для них информацию в отдельные текcтовые файлы, а также документы в локальной базе MongoDB.

После выполнения второго дага необходима ручная проверка корректности метаинформации по каждому файлу в локальной
базе MongoDB.

### Даг 3 - ETL_Процесс_Создания_Архивов
Третий даг ETL_Процесс_Создания_Архивов необходим для объединения загруженных файлов и их информации в
архивы. После создания архивов выполняется очистка памяти от файлов и их описаний, а затем выполняется 
загрузка архивов на сервер OMP Files. Архивы, которые до момента загрузки уже были на сервере,
отправляются в папку для повторяющихся архивов, а остальные загружаются. Также происходит создание общего документа
по каждому архиву в рабочей базе MongoDB

# При работе с программой через консоль

1. Откроется окно выбора необходимых рабочих папок
2. Выбор работы (работа с телеграмм, работа с загруженными файлами)
**При выборе работы с телеграмм можно:**
1. Подключиться к каналу (просмотреть доступные и выбрать)
  Функциональные особенности:
Выбор канала осуществляется вводом id канала от пользователя.

2. Проверить N сообщений канала на наличие файлов
  Функциональные особенности:
Сообщения считываются в цикле. Вытаскивается: информация о времени добавления сообщения в канал, описание сообщения, имя прикрепленного файла, размер, id. Параллельно выполняется запрос в интернет по имени файла для поиска информации.
3. Проверить только непрочитанные сообщения канала
4. Загрузить N сообщений из канала

4.1. Выборочная загрузка
  Функциональные особенности:
Вывод нумерованного списка сообщений.
Ввод номеров через консоль + воод номеров для объединения в коллекции по выбору пользователя

4.2. Автоматизированный способ

4.2.1. Работа с созданными коллекциями родственных файлов
  Функциональные особенности:
  удаление коллекций, группировка, разгруппировка.

5. Загрузка только метаинформации из сообщений для определенного канала
  Функциональные особенности:
  Загрузка текстового файла с описанием для сообщения, без скачивания самого файла составляющего.

Пункт 5 выполняется аналогично пункту 4 при наличии существующих загруженных файлов, находящихся в рабочей папке
При выполнении пунктов 4 или 5, записи о файлах добавляются в mongodb.

6. Создать аналитический отчет, включающий в себя создание двух xlsx файлов (otchet "data".xlsx и otchet_messages "data".xlsx):
 otchet "data".xlsx - Название канала	id	Непрочитанные сообщения	Cообщения c файлами	Общий объем
 otchet_messages "data".xlsx - Имя файла    Размер  Метаинформация
7. Потоковая выгрузка метаинформации 

**При выборе работы с файлами:**
1. Создание архивов для отдельных файлов и их метаинформаций. N архив = N файл + N файл_инфо
2. Создание архивов для коллекций файлов. 1 архив = N файлов + 1 файл_инфо 
3. Создание документов с метаинформацией из загруженных файлов не с телеграмм канала.

Примечание: Текстовый файл с описанием загруженной базы должен быть назван как "имя файла без расширения" + ".txt".
При выполнении пункта 3 создается документ MongoDB (для загруженных с интернета файлов) аналогичный существующим документам для файлов, загружаемых с телеграмм канала.

4. Перенос архивов на сервер OMP files
При выполнении пунктов 1 или 2 или 3, записи о файлах добавляются в mongodb.

4.1. Проверка на наличие существующих архивов

4.2. Загрузка повторяющихся архивов с сервера

5. Удаление файлов, архивов и файлов информации
6. Добавление времени загрузки архивов на сервер в документ коллекции MongoDB, если они были загружены вручную.

Описание пункта 6:
Программа не позволяет загрузить на сервер архивы большого объема (> 20 Гб или в зависисмости от загруженности сервера), в таком случае программа обладает функцией добавления времени загрузки архива на сервер в документ коллекции MongoDB. При выполнении соответстствующей функции программа соберет информацию с сервера и создаст в документе MongoDB поле upload_to_server_time, куда запишет значение времени загрузки.

Ограничения по пункту 6:
Необходимо наличие загруженных на сервер архивов в рабочей папке с архивами на компьютере.
